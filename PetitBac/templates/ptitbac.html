<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Petit Bac multijoueur – WebSocket</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>

<h1>Petit Bac multijoueur – temps réel</h1>

<section class="entete-lettre">
    <p>Lettre tirée : <span class="cellule-lettre" id="lettre-affichee">{{.Lettre}}</span></p>
</section>

<section class="zone-joueur">
    <h2>Ton plateau</h2>

    <form id="form-joueur">
        <div class="entete-joueur">
            <label for="pseudo">Pseudo</label>
            <input type="text"
                   id="pseudo"
                   name="pseudo"
                   class="champ-nom"
                   placeholder="Entre ton pseudo">
        </div>

        <div class="section-reponses">
            {{range $indice, $categorie := .Categories}}
                <div class="case-reponse">
                    <label for="cat{{$indice}}">{{$categorie}}</label>
                    <input type="text"
                           id="cat{{$indice}}"
                           name="cat{{$indice}}"
                           class="champ-categorie"
                           data-categorie="{{$categorie}}"
                           placeholder="Réponse...">
                </div>
            {{end}}
        </div>

        <button type="submit" class="bouton-principal">Envoyer mes réponses</button>
    </form>
</section>

<section class="resultats">
    <h2>Scores des joueurs connectés</h2>
    <table class="tableau-petit-bac" id="table-scores">
        <thead>
        <tr>
            <th>Joueur</th>
            <th>Score</th>
        </tr>
        </thead>
        <tbody id="scores-body">
        <!-- Rempli dynamiquement en JS -->
        </tbody>
    </table>
</section>

<script>
    let socket = null;

    function connecterWebSocket() {
        const proto = (window.location.protocol === "https:") ? "wss://" : "ws://";
        const url = proto + window.location.host + "/ws";
        socket = new WebSocket(url);

        socket.onopen = function () {
            console.log("WebSocket connecté");
        };

        socket.onmessage = function (event) {
            const data = JSON.parse(event.data);
            if (data.type === "state") {
                mettreAJourEtat(data);
            }
        };

        socket.onclose = function () {
            console.log("WebSocket fermé");
        };

        socket.onerror = function (err) {
            console.error("WebSocket erreur :", err);
        };
    }

    function mettreAJourEtat(etat) {
        // Met à jour la lettre (au cas où tu veux relancer une manche plus tard)
        const lettreSpan = document.getElementById("lettre-affichee");
        if (lettreSpan) {
            lettreSpan.textContent = etat.letter;
        }

        // Met à jour le tableau des scores
        const tbody = document.getElementById("scores-body");
        tbody.innerHTML = "";

        etat.players.forEach(function (p) {
            const tr = document.createElement("tr");

            const tdNom = document.createElement("td");
            tdNom.textContent = p.name || "Anonyme";

            const tdScore = document.createElement("td");
            tdScore.textContent = p.score + " pt" + (p.score > 1 ? "s" : "");

            tr.appendChild(tdNom);
            tr.appendChild(tdScore);
            tbody.appendChild(tr);
        });
    }

    document.addEventListener("DOMContentLoaded", function () {
        connecterWebSocket();

        const form = document.getElementById("form-joueur");
        form.addEventListener("submit", function (e) {
            e.preventDefault();
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                alert("Connexion WebSocket non disponible");
                return;
            }

            const pseudo = document.getElementById("pseudo").value.trim();
            if (pseudo !== "") {
                socket.send(JSON.stringify({
                    type: "join",
                    name: pseudo
                }));
            }

            const champs = document.querySelectorAll(".champ-categorie");
            const answers = {};
            champs.forEach(function (input) {
                const categorie = input.dataset.categorie;
                answers[categorie] = input.value;
            });

            socket.send(JSON.stringify({
                type: "answers",
                answers: answers
            }));
        });
    });
</script>

</body>
</html>
