<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Petit Bac multijoueur - WebSocket</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>

<h1>Petit Bac multijoueur en temps reel</h1>

<section class="entete-lettre">
    <p>
        Lettre tiree :
        <span class="cellule-lettre" id="lettre-affichee">{{.Lettre}}</span>
    </p>
    <p>
        Temps restant :
        <span id="timer-affiche">01:30</span>
    </p>
    <p class="info-manches" id="info-manches">Manche 1/5</p>
</section>

<section class="configuration-partie">
    <h2>Parametres de la partie</h2>
    <form id="config-form">
        <div class="champ-config">
            <label for="temps-manche">Temps par manche (secondes)</label>
            <input type="number" id="temps-manche" min="15" value="{{.TempsParManche}}">
        </div>
        <div class="champ-config">
            <label for="nb-manches">Nombre de manches</label>
            <input type="number" id="nb-manches" min="1" value="{{.NombreDeManches}}">
        </div>
        <div class="champ-config">
            <label for="categories-input">Categories (une par ligne)</label>
            <textarea id="categories-input" rows="5">{{range .Categories}}{{.}}
{{end}}</textarea>
        </div>
        <button type="submit" class="bouton-secondaire">Mettre a jour la partie</button>
        <p id="config-message" class="config-message"></p>
    </form>
</section>

<section class="zone-joueur">
    <h2>Ton plateau</h2>

    <form id="form-joueur">
        <div class="entete-joueur">
            <label for="pseudo">Pseudo</label>
            <input type="text"
                   id="pseudo"
                   name="pseudo"
                   class="champ-nom"
                   placeholder="Entre ton pseudo">
        </div>

        <div class="section-reponses">
            {{range $indice, $categorie := .Categories}}
                <div class="case-reponse">
                    <label for="cat{{$indice}}">{{$categorie}}</label>
                    <input type="text"
                           id="cat{{$indice}}"
                           name="cat{{$indice}}"
                           class="champ-categorie"
                           data-categorie="{{$categorie}}"
                           placeholder="Reponse...">
                </div>
            {{end}}
        </div>

        <button type="submit" class="bouton-principal" id="btn-send">Envoyer mes reponses</button>
    </form>

    <p id="message-manche" class="message-manche"></p>
    <p class="info-validation">Rappel : une reponse n'est valide que si au moins 2/3 des joueurs l'acceptent.</p>
</section>

<section class="zone-preparation" id="zone-preparation">
    <h2>Relancer une partie</h2>
    <p id="infos-preparation">Clique sur "Oui, je rejoue" pour voter la relance.</p>
    <button type="button" class="bouton-secondaire" id="btn-ready">Oui, je rejoue</button>
</section>

<section class="resultats">
    <h2>Scores des joueurs connectes</h2>
    <table class="tableau-petit-bac" id="table-scores">
        <thead>
        <tr>
            <th>Joueur</th>
            <th>Score manche</th>
            <th>Total global</th>
            <th>Statut</th>
        </tr>
        </thead>
        <tbody id="scores-body">
        </tbody>
    </table>
</section>
</body>

<script>
    let socket = null;
    let identifiantClient = null;

    function connecterWebSocket() {
        const proto = (window.location.protocol === "https:") ? "wss://" : "ws://";
        const url = proto + window.location.host + "/ws";
        socket = new WebSocket(url);

        socket.onopen = function () {
            console.log("WebSocket connecte");
        };

        socket.onmessage = function (event) {
            const data = JSON.parse(event.data);
            if (data.type === "state") {
                mettreAJourEtat(data);
                return;
            }
            if (data.type === "identity") {
                identifiantClient = data.id;
            }
        };

        socket.onclose = function () {
            console.log("WebSocket ferme");
        };

        socket.onerror = function (err) {
            console.error("WebSocket erreur :", err);
        };
    }

    function formatTemps(sec) {
        const m = Math.floor(sec / 60);
        const s = sec % 60;
        return (m < 10 ? "0" + m : m) + ":" + (s < 10 ? "0" + s : s);
    }

    function activerFormulaire(peutEnvoyer) {
        const inputs = document.querySelectorAll(".champ-nom, .champ-categorie, #btn-send");
        inputs.forEach(el => {
            el.disabled = !peutEnvoyer;
        });
    }

    function mettreAJourPreparation(etat, monJoueur) {
        const bloc = document.getElementById("zone-preparation");
        const info = document.getElementById("infos-preparation");
        const bouton = document.getElementById("btn-ready");
        if (!bloc || !info || !bouton) {
            return;
        }

        if (etat.gameOver) {
            bloc.style.display = "none";
            info.textContent = "Partie terminee.";
            bouton.disabled = true;
            return;
        }

        if (!etat.waitingRestart) {
            bloc.style.display = "none";
            bouton.disabled = true;
            return;
        }

        bloc.style.display = "block";
        const total = etat.readyTotal || 0;
        const seuil = total > 0 ? Math.floor(total / 3) + 1 : 1;
        let texte = `${etat.readyCount}/${etat.readyTotal} joueur(s) ont vote Oui.`;
        if (total > 0) {
            texte += ` Relance a partir de ${seuil} joueur(s) (> 1/3).`;
        }
        info.textContent = texte;
        bouton.disabled = !!(monJoueur && monJoueur.ready);
    }

    function mettreAJourEtat(etat) {
        const lettreSpan = document.getElementById("lettre-affichee");
        if (lettreSpan) {
            lettreSpan.textContent = etat.letter;
        }

        const timerSpan = document.getElementById("timer-affiche");
        if (timerSpan) {
            timerSpan.textContent = formatTemps(etat.remainingSeconds);
        }

        const infoManches = document.getElementById("info-manches");
        if (infoManches) {
            if (etat.roundLimit) {
                const courante = Math.min(etat.roundNumber, etat.roundLimit);
                infoManches.textContent = `Manche ${courante}/${etat.roundLimit}`;
            } else {
                infoManches.textContent = `Manche ${etat.roundNumber}`;
            }
        }

        let monJoueur = null;
        if (identifiantClient) {
            monJoueur = etat.players.find(p => p.id === identifiantClient) || null;
        }

        const champTemps = document.getElementById("temps-manche");
        if (champTemps && etat.roundDuration) {
            champTemps.value = etat.roundDuration;
        }
        const champManches = document.getElementById("nb-manches");
        if (champManches && etat.roundLimit) {
            champManches.value = etat.roundLimit;
        }
        const champCategories = document.getElementById("categories-input");
        if (champCategories && Array.isArray(etat.categories)) {
            champCategories.value = etat.categories.join("\n");
        }

        const peutJouer = etat.roundActive && monJoueur ? monJoueur.active : etat.roundActive;
        activerFormulaire(peutJouer && !etat.gameOver);

        const msg = document.getElementById("message-manche");
        if (msg) {
            if (etat.gameOver) {
                msg.textContent = "Partie terminee : le nombre maximum de manches a ete atteint.";
            } else if (etat.roundActive) {
                if (monJoueur && !monJoueur.active) {
                    msg.textContent = "Tu n'as pas confirme pour cette manche. Prepare-toi pour la prochaine.";
                } else {
                    msg.textContent = "";
                }
            } else if (etat.waitingRestart) {
                msg.textContent = "Manche terminee. Vote \"Oui, je rejoue\" (plus d'un tiers des joueurs requis).";
            } else {
                msg.textContent = "Manche terminee ! (un joueur a tout rempli ou le temps est ecoule)";
            }
        }

        mettreAJourPreparation(etat, monJoueur);

        const tbody = document.getElementById("scores-body");
        tbody.innerHTML = "";
        etat.players.forEach(function (p) {
            const tr = document.createElement("tr");

            const tdNom = document.createElement("td");
            tdNom.textContent = p.name || "Anonyme";

            const tdScoreManche = document.createElement("td");
            tdScoreManche.textContent = p.score + " pt" + (p.score > 1 ? "s" : "");

            const totalValue = p.totalScore || 0;
            const tdScoreTotal = document.createElement("td");
            tdScoreTotal.textContent = totalValue + " pt" + (totalValue > 1 ? "s" : "");

            const tdStatut = document.createElement("td");
            if (p.active) {
                tdStatut.textContent = "En jeu";
            } else if (p.ready) {
                tdStatut.textContent = "Pret";
            } else {
                tdStatut.textContent = "En attente";
            }

            tr.appendChild(tdNom);
            tr.appendChild(tdScoreManche);
            tr.appendChild(tdScoreTotal);
            tr.appendChild(tdStatut);
            tbody.appendChild(tr);
        });
    }

    document.addEventListener("DOMContentLoaded", function () {
        connecterWebSocket();

        const form = document.getElementById("form-joueur");
        form.addEventListener("submit", function (e) {
            e.preventDefault();
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                alert("Connexion WebSocket non disponible");
                return;
            }

            const pseudo = document.getElementById("pseudo").value.trim();
            if (pseudo !== "") {
                socket.send(JSON.stringify({
                    type: "join",
                    name: pseudo
                }));
            }

            const champs = document.querySelectorAll(".champ-categorie");
            const answers = {};
            champs.forEach(function (input) {
                const categorie = input.dataset.categorie;
                answers[categorie] = input.value;
            });

            socket.send(JSON.stringify({
                type: "answers",
                answers: answers
            }));
        });

        const boutonPret = document.getElementById("btn-ready");
        if (boutonPret) {
            boutonPret.addEventListener("click", function () {
                if (!socket || socket.readyState !== WebSocket.OPEN) {
                    return;
                }
                socket.send(JSON.stringify({type: "ready"}));
            });
        }

        const configForm = document.getElementById("config-form");
        if (configForm) {
            configForm.addEventListener("submit", function (e) {
                e.preventDefault();
                const message = document.getElementById("config-message");
                if (message) message.textContent = "Envoi en cours...";

                const temps = parseInt(document.getElementById("temps-manche").value, 10);
                const manches = parseInt(document.getElementById("nb-manches").value, 10);
                const categoriesBrutes = document.getElementById("categories-input").value.split(/\r?\n/);
                const categories = categoriesBrutes.map(c => c.trim()).filter(c => c.length > 0);

                fetch("/config", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({temps: temps, manches: manches, categories: categories})
                }).then(resp => {
                    if (!resp.ok) throw new Error("Erreur serveur");
                    return resp.json();
                }).then(() => {
                    if (message) message.textContent = "Parametres mis a jour ! Nouvelle partie en preparation...";
                }).catch(err => {
                    console.error(err);
                    if (message) message.textContent = "Impossible de mettre a jour la configuration.";
                });
            });
        }
    });
</script>

</html>





